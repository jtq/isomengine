<html>
<head>
	<title>Isometric 3D engine</title>
	<script src="http://jtq.github.io/require/index.js"></script>
	<style type="text/css">
body {
	padding-left: 120px;		/* Bump world along 40$ or so to account for extra width of diagonal when rotated */
}
.container {
	width: 400px;
	height: 400px;
}
	</style>
</head>
<body>

	<div class="container"></div>

	<script>

var world, container, renderer, assets, pathfinder;	// Convenience in debugging

function create(id, type, x, z, colour) {
	var obj = {
		id: id,
		type: type,
		x: x,
		z: z,
		element: renderer.createObjectElement(type, colour)
	};
	container.appendChild(obj.element);
	world.add(obj);
	return obj;
}

require(['../world.js', '../dom-renderer.js', '../asset-library.js', '../pathfinder.js'], function(World, Renderer, Assets, Pathfinder) {
	container = document.querySelector(".container");
	world = new World(20, 20);
	renderer = Renderer;
	assets = Assets;
	pathfinder = new Pathfinder(world, Pathfinder.prototype.COMPASS_DIRECTIONS);

	renderer.init(container, world, assets);

	var player = create("player", "player", 1, 0, "#0080ff");

	for(var i=0; i<50; i++) {
		var x, z;
		do {
			x = Math.floor(Math.random()*100);
			z = Math.floor(Math.random()*100);
		}
		while(world.getAt(x, z) !== null);

		create("building"+i, "block", x, z, "#c0c0c0");
	}

	/*create("building0", "block", 4, 4, "#c0c0c0");
	create("building1", "block", 3, 4, "#c0c0c0");
	create("building2", "block", 5, 4, "#c0c0c0");
	create("building3", "block", 4, 3, "#c0c0c0");
	create("building4", "block", 4, 5, "#c0c0c0");*/

	container.addEventListener("click", function(e) {
		var worldX = renderer.toWorldCoordinatesX(e.offsetX);
		var worldZ = renderer.toWorldCoordinatesZ(e.offsetY);

		world.getBy("type", "route").forEach(function(obj) {
			world.remove(obj);
			container.removeChild(obj.element);
		});
		world.getBy("type", "clearroute").forEach(function(obj) {
			world.remove(obj);
			container.removeChild(obj.element);
		});

		//var naiveRoute = pathfinder.findDirect([player.x, player.z], [worldX, worldZ]);
		var clearRoute = pathfinder.findClear([player.x, player.z], [worldX, worldZ], ["player"]);

		/*naiveRoute.forEach(function(step, i) {
			create("route"+i, "route", step.x, step.z, "transparent");
		});*/
		if(clearRoute === null) {
			console.error("No route from "+player.x+","+player.z+" to "+worldX+","+worldZ);
		}
		else{
			world.moveTo(player, worldX, worldZ);
			clearRoute.forEach(function(step, i) {
				create("clearroute"+i, "clearroute", step.x, step.z, "transparent");
			});
		}
	});

	requestAnimationFrame(function step() {
		world.step();
		renderer.render(world);
		requestAnimationFrame(step);
	});

	setTimeout(function() {
		renderer.setIsometric(true);
	}, 1000);
	
});
	</script>
</body>
</html>